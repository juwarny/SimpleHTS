Public chIndex As New CpIndex
Dim objStockChart As New StockChart
Dim objCodeMgr As New CpStockCode
Dim bCalculate


Private Sub Workbook_Open()
    'CommonModule Loading
    bCalculate = 0
    
End Sub

Private Sub cmbIndexKindList_Change()
   Debug.Print "cmbIndexKindList_Change"
   Dim arCode()
   
   If cmbIndexKindList.ListIndex = -1 Then
        cmbIndexKindList.ListIndex = 0
   End If
   
   nKind = cmbIndexKindList.ListIndex
    
   arCode = chIndex.GetChartIndexCodeListByIndex(nKind)
   cmbIndexList.Clear
   For I = LBound(arCode) To UBound(arCode)
       cmbIndexList.AddItem arCode(I)
   Next
End Sub

'지표콤보박스
Private Sub cmbIndexList_Change()
    Debug.Print "cmbIndexList_Change"
    chartIdx = chIndex.GetChartIndexByName(cmbIndexList.Text)
    Range("H1").value = chartIdx
End Sub

Private Sub CommandButton2_Click()
    objStockChart.SetInputValue 0, TextBox1.Text
    
    Dim arCode()
    Dim arKind
    ReDim arKind(0 To 6)
    
    objStockChart.SetInputValue 0, TextBox1.Text '종목코드
    ComboBox1.Clear
    ComboBox2.Clear
    
    ComboBox1.AddItem ("일")
    ComboBox1.AddItem ("주")
    ComboBox1.AddItem ("월")
    ComboBox1.AddItem ("분")
    ComboBox1.AddItem ("틱")
    ComboBox2.AddItem ("1")
    ComboBox2.AddItem ("2")
    ComboBox2.AddItem ("5")
    ComboBox2.AddItem ("15")
    
    
    arKind(0) = "가격 지표"
    arKind(1) = "대신개발 지표"
    arKind(2) = "추세 지표"
    arKind(3) = "변동성 지표"
    arKind(4) = "거래량 지표"
    arKind(5) = "기간활용 지표"
    
    cmbIndexKindList.Clear
    For I = LBound(arKind) To UBound(arKind)
        cmbIndexKindList.AddItem arKind(I)
    Next
    nKind = cmbIndexKindList.ListIndex
    If nKind = -1 Then
        nKind = 0
    End If
    arCode = chIndex.GetChartIndexCodeListByIndex(nKind)
        
    cmbIndexList.Clear
    For I = LBound(arCode) To UBound(arCode)
        cmbIndexList.AddItem arCode(I)
    Next
    

End Sub

Private Sub CommandButton3_Click()
    
    chIndex.put_IndexDefault (cmbIndexList.Text)
    
    Set r = Range("H8")
    value = chIndex.getSourceData
    r.Offset(0, 0).value = Chr(value)
    value = chIndex.get_Term1
    r.Offset(1, 0).value = value
    r.Offset(2, 0).value = chIndex.get_Term2
    r.Offset(3, 0).value = chIndex.get_Term3
    r.Offset(4, 0).value = chIndex.get_Term4
    r.Offset(5, 0).value = chIndex.get_Signal
    r.Offset(6, 0).value = Chr(chIndex.get_SignalMA)
    r.Offset(7, 0).value = chIndex.get_CalculateMethod
    r.Offset(8, 0).value = chIndex.get_DTerm1
    r.Offset(9, 0).value = chIndex.get_DTerm2
    
    
'H8
End Sub

Public Sub CommandButton1_Click()

    Dim series As New CpSeries
    Dim items() As Long
    Dim value As Variant
    Dim r As Range
    
    scode = TextBox1.Text
    
    objStockChart.SetInputValue 0, scode  '종목코드
    objStockChart.SetInputValue 1, Asc("2") '요청구분-갯수
    objStockChart.SetInputValue 4, 500 '요청갯수
    
    Value2 = ComboBox1.Text
    If "일" = Value2 Then
        Value2 = "D"
    End If
    
    If "주" = Value2 Then
        Value2 = "W"
    End If
    
    If "월" = Value2 Then
        Value2 = "M"
    End If
    
    If "분" = Value2 Then
        Value2 = "m"
    End If
    
    If "틱" = Value2 Then
        Value2 = "T"
    End If
    
    objStockChart.SetInputValue 6, Asc(Value2)

    If Not IsEmpty(Value2) Then
        If "m" = Value2 Or "T" = Value2 Then
            ReDim items(0 To 6)
            items(0) = 0
            items(1) = 1
            items(2) = 2
            items(3) = 3
            items(4) = 4
            items(5) = 5
            items(6) = 8
        Else
            ReDim items(0 To 5)
            items(0) = 0
            items(1) = 2
            items(2) = 3
            items(3) = 4
            items(4) = 5
            items(5) = 8
        End If
        
        objStockChart.SetInputValue 5, items
    End If

    value = ComboBox2.Text '주기
    If Not IsEmpty(value) Then
        objStockChart.SetInputValue 7, value
    End If

    objStockChart.SetInputValue 8, Asc("0") '갭보정
    objStockChart.SetInputValue 9, Asc("1") '수정주가
    

    Set r = Range("A98")
    Range(r, r.End(xlDown).EntireRow).ClearContents
    
    If "m" = Value2 Or "T" = Value2 Then
            objStockChart.BlockRequest
            cnt = objStockChart.GetHeaderValue(3)
                For I = 0 To cnt - 1 Step 1
                r.Offset(I, 0).value = objStockChart.GetDataValue(0, cnt - 1 - I) '날짜
                r.Offset(I, 1).value = objStockChart.GetDataValue(1, cnt - 1 - I) '시간
                r.Offset(I, 2).value = objStockChart.GetDataValue(1, cnt - 1 - I) '시가
                r.Offset(I, 3).value = objStockChart.GetDataValue(2, cnt - 1 - I) '고가
                r.Offset(I, 4).value = objStockChart.GetDataValue(3, cnt - 1 - I) '저가
                r.Offset(I, 5).value = objStockChart.GetDataValue(4, cnt - 1 - I) '종가
                r.Offset(I, 6).value = objStockChart.GetDataValue(5, cnt - 1 - I) '거래량
                series.Add r.Offset(I, 5).objStockChart, r.Offset(I, 2).value, r.Offset(I, 3).value, r.Offset(I, 4).value, r.Offset(I, 6).value
            Next I
            Set r = r.Offset(I, 0)
    Else
            objStockChart.BlockRequest
            cnt = objStockChart.GetHeaderValue(3)
                For I = 0 To cnt - 1 Step 1
                r.Offset(I, 0).value = objStockChart.GetDataValue(0, cnt - 1 - I) '날짜
                r.Offset(I, 1).value = 0                             '시간
                r.Offset(I, 2).value = objStockChart.GetDataValue(1, cnt - 1 - I) '시가
                r.Offset(I, 3).value = objStockChart.GetDataValue(2, cnt - 1 - I) '고가
                r.Offset(I, 4).value = objStockChart.GetDataValue(3, cnt - 1 - I) '저가
                r.Offset(I, 5).value = objStockChart.GetDataValue(4, cnt - 1 - I) '종가
                r.Offset(I, 6).value = objStockChart.GetDataValue(5, cnt - 1 - I) '거래량
                series.Add r.Offset(I, 4).value, r.Offset(I, 1).value, r.Offset(I, 2).value, r.Offset(I, 3).value, r.Offset(I, 5).value
            Next I
            Set r = r.Offset(I, 0)
    End If
    
    chIndex.series = series
    chIndex.put_IndexKind (cmbIndexList.Text)

    value = Range("H8").value
    If Not IsEmpty(value) Then
        If 0 = value Then
            chIndex.SourceData = value
        Else
            chIndex.SourceData = Asc(value)
        End If
    End If
    value = Range("H14").value
    If Not IsEmpty(value) Then
        chIndex.SignalMA = Asc(value)
    End If
    value = Range("H15").value
    If Not IsEmpty(value) Then
        chIndex.CalculateMethod = Asc(CStr(value))
    End If
    value = Range("H9").value
    If Not IsEmpty(value) Then
        chIndex.Term1 = Range("H9").value
    End If
    value = Range("H10").value
    If Not IsEmpty(value) Then
        chIndex.Term2 = Range("H10").value
    End If
    value = Range("H11").value
    If Not IsEmpty(value) Then
        chIndex.Term3 = Range("H11").value
    End If
    value = Range("H12").value
    If Not IsEmpty(value) Then
        chIndex.Term4 = Range("H12").value
    End If
    value = Range("H16").value
    If Not IsEmpty(value) Then
        chIndex.DTerm1 = Range("H16").value
    End If
     value = Range("H17").value
    If Not IsEmpty(value) Then
        chIndex.DTerm2 = Range("H17").value
    End If
    value = Range("H13").value
    If Not IsEmpty(value) Then
        chIndex.Signal = Range("H13").value
    End If
    
    ' 차트지표 초기값 자동 셋팅
    'chIndex.put_IndexDefault (cmbIndexList.Text)
    indexID = chIndex.GetChartIndexByName(cmbIndexList.Text)
    
     If bCalculate = 0 Then
        chIndex.Calculate
    Else
        chIndex.Update
    End If
    
    ' 지표결과값 셋팅
    'Set r = Range("H13")
    Set r = Range("H98")
    
    For J = 0 To chIndex.ItemCount - 1
        nCnt = chIndex.GetCount(J)
        'For I = 0 To nCnt - chIndex.GetSkipResultCount(J) - 1 Step 1
        For I = 0 To nCnt - 1 Step 1
            r.Offset(I, J).value = chIndex.GetResult(J, I)
        Next I
    Next J
    
    ' 라인명 셋팅
   
   arLineList = chIndex.GetLineResults(indexID)
    Set t = Range("H97")
    nCnt = chIndex.GetLineCount(J)
    
    For m = 0 To 5 - 1
        t.Offset(0, m) = ""
        If m < nCnt Then
            t.Offset(0, m) = arLineList(m)
        End If
    Next m
    
    chIndex.MakeIndSignal
    
    Set rSignal = Range("M98")
    For J = 0 To chIndex.SignalCount - 1
        nCnt = chIndex.GetCount(J)
        For I = 0 To nCnt - 1 Step 1
            nSignal = chIndex.GetIndSignalResult(J, I)
            If (nSignal = 1) Then
                rSignal.Offset(I, J).value = "1"
            ElseIf (nSignal = 2) Then
                rSignal.Offset(I, J).value = "2"
            Else
                rSignal.Offset(I, J).value = "0"
            End If

        Next I
    Next J


End Sub


Private Sub CommandButton4_Click()
    bTimer = True
    SetTimer
End Sub

Private Sub CommandButton5_Click()
    bTimer = False
End Sub


Private Sub TextBox1_KeyDown(ByVal KeyCode As MSForms.ReturnInteger, ByVal Shift As Integer)
    If KeyCode = 13 Then
       lbCodeName.Caption = objCodeMgr.CodeToName(TextBox1.Text)
    End If
End Sub
